/*
 * By including this file on the page you add 'default load of the announcement popups' functionality
 * on any MVC page that inherits from _LayoutMain.cshtml.
 */

$(function () {
    new announcementPopups();
});

var announcementPopups = function () {
    var self = this;
    self.init();
}

announcementPopups.prototype.init = function () {
    var path = location.pathname;

    var page = JSON.stringify({
        page: path
    });

    this.getAnnouncements(page, function (data) {

      if (data !== null && data != undefined) {
        var options = {
            body: "<div><p>" + data.Body + "</p></div>",
            title: data.Title,
            closeCallback: function () {
              console.log("closing popup");
              $.ajax({
                url: "/Announcement/DisablePopup",
                cache: false,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({ announcementId: data.ID }),
                error: function (xhr, textStatus, errorThrown) {
                  CMP.Utils.ErrorLogging.logError("Could not disable Announcement", "AnnouncementPopup.js", null, null, errorThrown);
                }
              });
            }
        }
        showCustomPopup(options);
      }
    });
}

announcementPopups.prototype.getAnnouncements = function (parameters, successCallback) {
    var baseurl = "/Announcement/GetPopup";
    $.ajax({
        url: baseurl,
        cache: false,
        type: "POST",
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        data: parameters,
        success: successCallback,
        error: function (xhr, textStatus, errorThrown) {
          CMP.Utils.ErrorLogging.logError("Could not fetch Announcement", "AnnouncementPopup.js", null, null, errorThrown);
        }
    });
}