@{
    ViewBag.Title = "Search Results";
    Layout = "~/Views/Shared/_LayoutWithFilter.cshtml";
}

@model IHS.Apps.CMP.Models.ViewModels.ResultsPageModel

@section page_title
{

    <div class="page-header with-search-bar with-data-bind">
        <div class="search-bar">
            <div class="dashboardHeader" style="display:inline-block">
                <span class="title h1">
                    @Model.Name
                    @if (!string.IsNullOrEmpty(Model.SubTitle))
                    {
                        <small>@Model.SubTitle</small>
                    }
            </div>
            <div style="    position: absolute;right: 28px; bottom: -6px;">
                <span style="top: 7px;position: absolute; left: -92px;">View chart by:</span>
                <ul class="hand inline-block nav nav-tabs u-margin-Bn" id="lenstabs">
                    <!-- ko with: gridChartVM -->
                    <!-- ko foreach: availbleChartTypes -->
                    <li data-bind="css:{active: $index() == 0}">
                        <a data-toggle="tab" class="u-padding-Axxs u-padding-Ls u-padding-Rs"  data-bind="css:$data.cssClass , attr:{title:$data.tooltip} ,  text:$data.name , click: $parent.changeChartTab" href="#"></a>
                    </li>
                    <!-- /ko-->
                    <!-- /ko-->
                </ul>
            </div>
            <ul class="nav nav-tabs toolbar nav-tab-right" role="menubar">
                <li>
                    <a href="#" data-bind="click:tutorial.start.bind(tutorial)"><i class="icon-tutorial large"></i>Tutorial</a>
                </li>
                <li id="savedSearchesDropdown" class="dropdown u-inline-block pull-right" role="menuitem">
                    <a data-bind="click:gridChartVM.savedSearchesVM.CheckSavedSearchesLoaded" href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="icon-folder-open large"></i> My Saved Searches
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                        <li><a href="javascript:void(0)" data-bind="click: function(){vm.commandsVM.saveSearch()}" role="menuitem"><i class="icon-folder-open"></i> Save Current Search</a></li>
                        <li data-bind="visible: gridChartVM.savedSearchesVM.savedSearches().length == 0" style="height: 60px;" role="menuitem">
                            <div class="loading sm text" data-bind="visible: !gridChartVM.savedSearchesVM.savedSearchesLoaded()"> Loading...</div>
                            <p class="u-padding-Hs u-padding-Vxxs" data-bind="visible: gridChartVM.savedSearchesVM.savedSearchesLoaded"> No searches currently saved. </p>
                        </li>
                        <!-- ko with: gridChartVM.savedSearchesVM -->
                        <li data-bind="scrollbar: {}" style="max-height:300px;" role="menuitem">
                            <div data-bind="foreach: savedSearches">
                                <div class="u-padding-As relative">
                                    <a class="inline-block u-margin-Rxl" data-bind="click: $parent.loadSavedSearch, text: Name" href="#"></a>
                                    <a class="btn" style="position: absolute;top:5px;right: 5px; padding: 5px;" href="#" data-bind="interactiveDropdown: true, click: ToggleMerging, css:{'btn-primary':Merging, 'btn-link': !Merging()}" title="Merge searches by clicking here to select this search, ensure you select at least two to merge.">
                                        <i class="icon-flow-merge u-rotate-90 xlarge u-margin-An u-vertical-middle"></i>
                                    </a>
                                </div>
                            </div>
                        </li>

                        <li data-bind="fadeVisible: Merging,interactiveDropdown: true" role="menuitem">
                            <hr /><h4 class="u-padding-Ls">Merge searches</h4>
                            <div class="u-padding-As">
                                <span>New search name</span>
                                <input type="text" placeholder="name" data-bind="interactiveDropdown: true, value:NewSearchName" class="form-control" />
                                <input id="checkKeepExistingSearch" type="checkbox" data-bind="interactiveDropdown: true, checked:KeepExistingSearches" />
                                <label for="checkKeepExistingSearch" data-bind="interactiveDropdown: true">Keep Existing Searches</label>
                                <button class="width-60 u-margin-Ts btn btn-primary" data-bind="interactiveDropdown: true, click: mergeSearches">Save</button>
                            </div>
                        </li>
                        <!-- /ko -->
                    </ul>
                </li>
                <!-- ko with: gridChartVM.customisationsVM-->

                <li class="dropdown u-inline-block pull-right" role="menuitem">
                    @*KEEP THIS <a data-bind="click: CreateScenario" href="#">Create a scenario</a>*@

                    @*@Html.Partial("../AandD/JDB/CustomisationsPanel")*@
                </li>
                <!-- /ko -->
            </ul>

        </div>
    </div>

}

@section additional_css
{
    @Styles.Render("~/Content/results")
    <link href="@Url.Content("~/Views/AandD/JDB/DefenceBudgets.css")" rel="stylesheet">
}

@section additional_scripts
{
    @Scripts.Render("~/bundles/results")
    @Scripts.Render("~/bundles/highstock")
    @Scripts.Render("~/bundles/highstock-export")
    @Scripts.Render("~/bundles/defencebudgets")

    <script>
        var vm;
        //qualtricsPopup('SV_cuTfwNeCV2nVwuF', 1000 * 60 * 2, "Please take a few moments to let us know what you think about the Defence Budgets Chart Beta.", 'JDBGuidedBeta');
        useFacetCaching = true;
        $(document).ready(function () {

            var searchQuery = window.location.search.substring(1) + window.location.hash;

            var options = {
                enableSearchBarAutoComplete: @Model.EnableSearchBarAutoComplete.ToString().ToLowerInvariant(),
                showAdvancedSearch: @Model.ShowAdvancedSearch.ToString().ToLowerInvariant(),
                showSearchBar: @Model.ShowSearchBar.ToString().ToLowerInvariant(),
                tutorial: {
                    cookie: "IHS_POPUP_04C9A6AE_4B8E_4577_A8B0_B934BA732E5F",
                    name: "DefenceBudgetsTutorial",
                    maxPages: 8
                },
                userSettings : @Html.Raw(Model.Settings.ToJson())
            };

            vm = new ResultsVM('container', searchQuery, options, {gridChartVM: jdbGridChartVM});
            vm.gridChartVM.GuidedBeta =true;
            vm.gridChartVM.SetupGuidedBeta();

            $.getJSON("/Views/AandD/JDB/help.json", function(helpData){
                window.helpLinks = window.helpLinks || {};
                $.extend(window.helpLinks, helpData);
            });


            $('.tipsyMe').tipsy();
           // $('#settingMenu > ul > li:nth-child(10)').hide();
            ApplyTipsyToolTips(".tipsyMe", "n");

            $(document).bind('FacetsProcessed', function () {
                $("#facetsDiv > div > div > ul > li > a:contains('Standard')").hide();
                $("#facetsDiv > div > div > ul > li > a:contains('Platform')").hide();
                //if (vm.gridChartVM.lastFacetTabSelected() != null)
                //{
                //    _.delay(function () {
                //        FacetPanelGroupTabHeaderClicked(vm.gridChartVM.lastFacetTabSelected());
                //    }, 1000);
                //}
            });

            _.delay(function () {
                // We want to use localstorage if possible
                StorageObject = localStorage;
                var d = new Date();
                var thisDayAndMonth = d.getMonth() + "-" + d.getDate();
                var JDBLastClearedStorage = "JDBLastClearedStorage";
                // Check when we last cleared
                var existing = StorageObject.getItem(JDBLastClearedStorage);
                var clearStorage = existing && existing != thisDayAndMonth;
                if (clearStorage)
                {
                    StorageObject.clear();
                }
                StorageObject.setItem(JDBLastClearedStorage, thisDayAndMonth);


            }, 1000);

        });
    </script>
}

@section additional_markup
{
    @Html.Partial("../AandD/JDB/Tutorial", "datapage-lens")
}

@section filters
{
    <div id="facetsDiv" data-bind="with : facetsVM">

        @Html.Partial("LinkBreadCrumb", Model.Breadcrumb)

        @Html.Partial("Results/Facets/FacetsPanel")
    </div>

    @Html.Partial("../AandD/JDB/Tutorial", "filters-lens")
}

<div class="grid-1">
    <!-- ko with: gridChartVM -->

    <div class="width-100">
        <div class="hidden" id="subchartContainer" data-bind="with:  $root.gridChartVM.subCharts">
            <button data-bind="css:{hidden : $root.gridChartVM.subCharts.visibleChartsCount() > 0}" id="buttonChartAxisChooserModal" class="btn btn-primary btn-sm u-margin-Rxxl u-padding-An u-padding-Rs "
                    data-toggle="modal" data-target="#addChartChooseAttributesDiv">
                <i class="icon-plus"></i>Add a new chart
            </button>
            <button data-bind="click: function(){ShowDefaultCharts($data.currentLens().name)} , css:{hidden : $root.gridChartVM.subCharts.visibleChartsCount() > 0}" class="btn btn-primary btn-sm u-margin-Rxxl u-padding-An u-padding-Rs ">
                <i class="icon-plus"></i>Show Default charts
            </button>
            <div class="modal fade" id="addChartChooseAttributesDiv" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <div class="modal-content">
                        <div class="modal-header u-padding-As u-padding-Ll">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                            <h2 class="corp-blue">Load chart - please make some choices</h2>
                        </div>
                        <div class="modal-body">
                            <div class="grid">
                                <div class="grid-1-2">

                                    <span class="u-font-125">
                                        Your new chart will be refined based on the search you have already made. It will
                                        also get updated each time you change your search. Please select a value for each of the options below.
                                    </span>

                                    <div class="u-margin-Al">
                                        <h2>X Axis</h2>Choose what you want to be the bottom axis.<br />

                                        <select class="form-control u-font-125" data-bind="optionsValue: 'key', value: XValue, options: XValues, optionsText: 'text', "></select>
                                    </div>
                                    <div class="u-margin-Al">
                                        <h2>Y Axis</h2>Choose which value you want to see plotted.<br />

                                        <select class="form-control  u-font-125" data-bind="value:YValue,  options: YValues, optionsText: 'text',optionsValue: 'key',   "></select>
                                    </div>
                                    <div class="u-margin-Al">
                                        <h2>Grouping</h2>Choose how you want to group the data, or select "Nothing" to have no grouping in the columns.<br />
                                        <select class="form-control u-font-125" data-bind="value:GroupValue, options: GroupValues, optionsText: 'text', optionsValue: 'key' "></select>
                                    </div>

                                    <div class="u-margin-Al" data-bind="css:{hidden:showChartTypeChooser()==false}">
                                        <h2>Chart Type</h2>
                                        <div class="btn-group" role="group" aria-label="First group">
                                            <button data-bind="css:{'btn-success ':chartType() == 'Column'}, click:function(){chartType('Column')}" class="btn  btn-default"><i class="icon-chart-bar xlarge"></i>Column</button>
                                            <button data-bind="css:{'btn-success ':chartType() == 'Pie'}, click:function(){chartType('Pie')}" type="button" class="btn btn-default"><i class="icon-chart-pie xlarge"></i>Pie</button>
                                            <button data-bind="css:{'btn-success ':chartType() == 'Area'}, click:function(){chartType('Area')}" type="button" class="btn btn-default"><i class="icon-chart-area xlarge"></i>Area</button>
                                        </div>
                                    </div>
                                    <div class="u-margin-Al" data-bind="visible: $data.showXGCountsInModal">
                                        <div data-bind="toggleClick:$data.OpenCountsInModal" class="hand">
                                            <i data-bind="css:{'icon-up-dir' :OpenCountsInModal, 'icon-down-dir':OpenCountsInModal() == false }" class="xlarge"></i> Advanced
                                        </div>
                                        <div data-bind="visible: $data.OpenCountsInModal" class="width-40">
                                            <h3>Maximum number of X values</h3>
                                            <select class="form-control u-font-135" data-bind="value: $data.xCount, options: $data.xCounts"></select>
                                            <h3>Maximum number of Legend values</h3>
                                            <select class="form-control u-font-135" data-bind="value: $data.gCount, options: $data.gCounts"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid-1-2">

                                    <div id="demochartContainer">
                                        <h2>Example Chart</h2>
                                        <div id="demoChart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-lg btn-default " data-dismiss="modal">
                                Cancel
                            </button>
                            <button class="btn btn-lg btn-primary" data-bind="click: AddChart" data-dismiss="modal">
                                Load Chart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
        <div data-bind="visible: $parent.viewChart" id="subchartsContainer">
                <!-- ko foreach: charts -->
                <!-- ko if: $parent.currentLens() != undefined -->
                <!-- ko if: $data.lens ==  $parent.currentLens().name -->

                <div class='pull-left width-48 u-padding-Am chartWrapper u-margin-Axs u-margin-Bm relative' data-bind="attr:{id:$data.chart.chartdivId + 'wrapper'},css1: {'width-100' : $parent.charts().length == 1 , fullscreenSubchart: chartFullscreen }">
                    <div class="min-height" style="position:relative" data-bind="css: {fullscreenSubchart: chartFullscreen }">

                        <div data-bind="css:{'opacity-10-hover-100':$data.active()==false}" class="btn-group pull-right  subChartToolBar" role="group">
                            <div class="btn-group" role="group">
                                <button class="btn btn-default btn-sm btn-primary" data-bind="css:{hidden:$data.undoOperations().length == 0} , click: $data.undoLastOperation"><i class="icon-left-open"></i><span class="tooltip tooltipwide">Undo last drilldown on this chart</span></button>

                                <button class="btn btn-default btn-sm" data-toggle="dropdown" aria-expanded="false">
                                    <i class="icon-export small"></i>
                                    <span class="tooltip">Export</span>
                                    <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                   @*<li><a href="#" data-bind="click: editChartTitle"><i class="icon-pencil"></i> Edit chart title</a></li>*@
                                   @*<li class="divider"></li>*@
                                    <li><a href="#" data-bind="click: $data.ExportChart.bind($data,'pdf')"><i class="icon-file-pdf"></i> Export as PDF</a></li>
                                    <li><a href="#" data-bind="click: $data.ExportChart.bind($data,'png')"><i class="icon-file-image"></i> Export as PNG</a></li>
                                    <li><a href="#" data-bind="click: $data.ExportChart.bind($data,'svg')"><i class="icon-file-image"></i> Export as SVG</a></li>
                                    <li><a href="#" data-bind="click: $data.ExportChart.bind($data,'jpg')"><i class="icon-file-image"></i> Export as JPEG</a></li>
                                    <li><a href="#" data-bind="click: $data.PrintChart"><i class="icon-print"></i> Print chart</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#" data-bind="click: exportDataTable"><i class="icon-file-excel"></i> Export chart summary to Excel</a></li>
                                    <li><a class="tipsyMe" title="Click here to view an excel datasheet based on your current search" href="#" data-bind="click: loadCustomDataSheet"><i class="icon-file-excel"></i>Export Datasheet for this search</a></li>
                                </ul>
                            </div>

                            <div class="btn-group dropdown" role="group">
                                <button class="btn btn-default btn-sm" data-toggle="dropdown" aria-expanded="false">
                                    <i class="icon-cog small"></i>
                                    <span class="tooltip">Add remove & edit chart</span>
                                    <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                    <li><button data-toggle="modal" data-target="#addChartChooseAttributesDiv" class="btn btn-default width-100  btn-sm" role="button" data-bind="click: $data.add "><i class="icon-plus pull-left"></i><span class="tooltip">Add a chart to the page</span><span class="pull-left u-padding-Lm">Add chart</span></button> </li>
                                    <li><button data-toggle="modal" data-target="#addChartChooseAttributesDiv" class="btn btn-default width-100  btn-sm" role="button" data-bind="attr:{id:$data.chart.chartdivId +'_edit'} , click: $data.edit "><i class="icon-cog pull-left"></i><span class="tooltip">Edit this chart</span><span class="pull-left u-padding-Lm">Edit chart</span></button>         </li>
                                    <!-- Edit Chart Title/Subtitle -->
                                    <li>
                                        <button class="btn btn-default width-100 btn-sm btn-edit-title" role="button" data-bind="toggleClick: $data.editTitle"><i class="icon-pencil pull-left"></i><span class="tooltip">Edit this chart title</span><span class="pull-left u-padding-Lm">Edit chart title</span></button>
                                    </li>
                                    <li><button class="btn btn-default  width-100  btn-sm" data-bind="toggleClick: $data.queryRemove "><i class="icon-trash pull-left"></i><span class="tooltip">Remove this chart from the page</span><span class="pull-left u-padding-Lm">Remove chart</span></button>                                                    </li>
                                    <li data-bind="css:{hidden: $data.queryRemove() == false}">
                                        <button class="btn btn-warning width-100  btn-sm" data-bind="click: $data.remove "><i class="icon-trash pull-left"></i><span class="tooltip">Are you sure?</span><span class="pull-left u-padding-Lm">Yes</span></button>
                                        <button class="btn btn-default width-100  btn-sm" data-bind="toggleClick: $data.queryRemove "><i class="icon-trash pull-left"></i><span class="tooltip">Are you sure?</span><span class="pull-left u-padding-Lm">No</span></button>
                                    </li>
                                </ul>
                            </div>
                            <button class="btn btn-default   btn-sm" data-bind="toggleClick: $data.chartFullscreen, css:{'btn-primary': $data.chartFullscreen}"><i class="icon-resize-full" data-bind="css:{'icon-resize-small':$data.chartFullscreen}"></i><span class="tooltip">View chart full screen</span></button>
                            <button class="btn btn-default   btn-sm" data-bind="toggleClick: $data.frozen, css:{'btn-primary': $data.frozen}"><i class="icon-lock"></i><span data-bind="css:{'hidden': !$data.frozen()}" class="tooltip">Unfreeze</span><span data-bind="css:{'hidden': $data.frozen}" class="tooltip tooltipwide">Freeze, do not update this chart when I change filters.</span></button>
                            <button class="btn btn-default toggle-chartData btn-sm" data-bind="toggleClick: $data.chartDataTable, css:{'btn-primary': $data.chartDataTable()==false}"><i class="icon-th"></i><span class="tooltip">Toggle chart summary</span></button>
                        </div>
                        <div class="chartDiv " data-bind="attr:{id:$data.chart.chartdivId}">

                            <h2> Loading chart, please wait.</h2>

                            <div class="chartLoading">

                            </div>
                        </div>
                        @*

                            CHART REFINE MODAL ********************************************************************

                        *@
                        <div data-bind="css:{hidden: $data.refineVisible() == false}" class="hidden ChartRefinerModal">
                            <div class="grey4-bg u-padding-Axxs u-padding-Lm modal-header draggable ui-draggable-handle">
                                <button type="button" class="close" data-bind="click:function(){$data.refineVisible(false);}" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>
                                <h3 class="u-margin-An">
                                    <i class="icon-move small" style="margin-left: -10px;"></i>
                                    <span id="chartContextTitle">Chart drilldown</span>
                                </h3>
                            </div>
                            <div class="modal-body">
                                <div>
                                    <!-- light refiner-->
                                    <div class="checkbox" title="Check this if you want to filter the next chart">
                                        <label>
                                            <input type="checkbox" data-bind="checked: $data.wantsToFilterOnX" />
                                            <span class="u-margin-Tn" data-bind="text:$data.XFilterValue">x</span>
                                        </label>
                                    </div>
                                    
                                    <!-- ko if: $data.GFilterValue() !== "All Others"-->
                                    <div data-bind="css:{hidden: $data.g() == 'NOTHING' || $data.SelectedChartItems().filter(function(d) { return d.value == $data.GFilterValue() }).length > 0}" class="checkbox" style="float:left">
                                        <label>
                                            <input type="checkbox" data-bind="checked: $data.wantsToFilterOnG"/>
                                            <span class="u-margin-Tn" data-bind="text:$data.GFilterValue">x</span>
                                        </label>
                                    </div>
                                    <!--/ko-->
                                    
                                    <select class="form-control width-50" style="clear:both" data-bind="optionsValue: 'key', value: RefineNextXValue, options: $parent.XValues, optionsText: 'text', "></select>
                                    <!-- ko if: $data.GFilterValue() !== "All Others"-->
                                    <button data-bind="click:function(){$data.RefineChart('Add')}" class="u-margin-Bl btn btn-primary btn-sm u-margin-Ts pull-left">
                                        <i class="icon-plus"></i>Drill down
                                    </button>
                                    <!--/ko-->
                                </div>
                                
                                <div class="grey4-bg u-padding-Axxs u-padding-Lm u-margin-Tl" style="clear:both;" >
                                    <span class="u-font-125">Top Ten Programs - </span>
                                    <span data-bind="visible:$data.wantsToFilterOnX, text:$data.XFilterValue() + ' - '"></span>
                                    <span data-bind="visible:$data.wantsToFilterOnG, text:$data.GFilterValue()"></span>
                                </div>                                
                                <div class="u-padding-Am" data-bind="css:{'hidden':$data.SelectedChartItems().length != 0}" style="clear: both;">
                                    <table class="table">
                                        <tbody>
                                            <tr><th>Record Id</th><th>Program Name</th><th>Supplier</th><th data-bind="text:$parent.parent.currentUnit"> USD</th></tr>
                                            <!-- ko foreach: TopTenItems -->
                                            <tr>
                                                <td>
                                                    <p class="hand" data-bind="css1:{'icon-right-dir' : !expanded(), 'icon-down-dir' : expanded} , click:function(){$parent.loadDescription($data)}">
                                                        <i data-bind="css:{'icon-right-dir' : !expanded(), 'icon-down-dir' : expanded()}"></i>
                                                        <span class="hand blue tab-underline" data-bind="text: ItemID">
                                                        </span>
                                                    </p>

                                                </td>
                                                <td><span data-bind="text: ITEMNAME"></span></td>
                                                <td><span data-bind="text: STD_SUPPLIER"></span></td>
                                                <td><span data-bind="text: SERIESVAL"></span></td>
                                            </tr>
                                            <tr data-bind="css:{hidden:!expanded()}">
                                                <td colspan="4" style="max-width:300px;">
                                                    <span class="grey1" data-bind="text: DESCRIPTION">Loading</span>
                                                </td>
                                            </tr>

                                            <!-- /ko -->
                                            <tr data-bind="visible: !TopTenItems().length">
                                                <td><span class="loading"></span></td>
                                                <td><span></span></td>
                                                <td><span></span></td>
                                                <td><span></span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                </div>
                        </div>
                        <div class='u-overflow-auto u-font-85' data-bind="css:{hidden:$data.chartDataTable() == false},attr:{id:$data.chart.chartdivId + 'DataTable'}"></div>
                    </div>
                </div>
                <!-- /ko -->
                <!-- /ko -->
                <!-- /ko -->
            </div>
        </div>
    </div>

    <!-- /ko -->
</div>
<div class="grid gridJDB" data-bind="visible: gridChartVM.viewGrid">
    <div class="grid-1">

        <div data-bind="with : filterTabsVM">
            @Html.Action("GetFilterTabs", "Search")
        </div>

        <div data-bind="with: paginationVM">
            @Html.Partial("PartialPages/Results/GridMenu", Model.GridMenu)
        </div>
    </div>
    <div class="grid-1 resultsContainer" data-bind="with : gridVM">
        <div data-bind="visible : showAdvancedSearchMessage" style="display: none;">
            <br />
            <p>Enter your search terms and then select the search button to view your results. You can use stemming, wildcards and proximity to narrow your search.</p>
            <br />
            <p>To add filters, select the left filter/s you require and then select the ‘Apply Filters’ button.</p>
        </div>

        <div id="resultsGrid" data-bind="dynamicHtml : resultsBodyHtml">
        </div>

        <div data-bind="visible: isAppending" style="height: 60px; position: relative">
            <div class="loading"></div>
        </div>
    </div>

    <div class="grid-1 text-center" data-bind="with : paginationVM">
        @Html.Partial("PartialPages/Results/Pagination")
    </div>

    <div class="loading dimmer" data-bind="visible : gridVM.isLoading"></div>
</div>

<div id="chartContextMenu" class="u-border-all dialog width-60 modal-content" data-bind="visible: gridChartVM.viewingChartContextMenu, with: gridChartVM">
    <div class="grey4-bg u-padding-Axxs u-padding-Lm modal-header draggable">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" data-bind="toggleClick: viewingChartContextMenu"><span aria-hidden="true">×</span></button>
        <h3 class="u-margin-An">
            <i class="icon-move small" style="margin-left: -10px;"></i>
            <span id="chartContextTitle"></span>
        </h3>
    </div>
    <div class="dropdown u-inline-block u-padding-Lxxs">
        <br />
        <span>Drill down and change chart segment.</span><br />
        <a id="_defenceSegmentDropdownTitle2" href="#" class="dropdown-toggle" data-toggle="dropdown">
            <span data-bind="text:DefenceSegment().text"></span>
            <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
                <a tabindex="-1" href="#">System Level</a>
                <ul id="_ChangeDefenceSegmentDropdown2" class="dropdown-menu" data-bind="foreach: settings.defenceSegments">
                    <li data-bind="css:{active: $parent.DefenceSegment() == $data}"><a data-bind="attr:{'data-value': key}, text:text, click: $parent.TopTenClicked.bind($data, $parent)" role="menuitem" href="#"></a></li>
                </ul>
            </li>
            <li class="dropdown-submenu" data-bind="css:{disabled: !CustomAttributes().length}">
                <a tabindex="-1" href="#">Custom Attributes</a>
                <ul class="dropdown-menu" data-bind="foreach: CustomAttributes,visible: CustomAttributes().length">
                    <li data-bind="css:{active: $parent.DefenceSegment() == $data}"><a data-bind="attr:{'data-value': key}, text:text, click: $parent.TopTenClicked.bind($data, $parent)" role="menuitem" href="#"></a></li>
                </ul>
            </li>
            <li class="dropdown-submenu" data-bind="css:{disabled: !CustomSegments().length}">
                <a tabindex="-1" href="#">My Customisations</a>
                <ul class="dropdown-menu" data-bind="foreach: CustomSegments,visible: CustomSegments().length">
                    <li data-bind="css:{active: $parent.DefenceSegment() == $data}"><a data-bind="attr:{'data-value': key}, text:text, click: $parent.TopTenClicked.bind($data, $parent)" role="menuitem" href="#"></a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div id="chartContextDropdown" class="u-padding-As">
    </div>
    @*<div class="dropdown u-padding-As">
            <a id="topTenLabel" class="u-padding-Lxxs" onclick="GetTopTenPrograms(); return false;" href="#"></a>
        </div>*@
    <div id="chartContextDropdownSubtitle" class="u-padding-An u-padding-Lm"> </div>
    <div id="topTen">
        <div class="u-padding-As u-padding-Tl">
            Top ten records for
            <div id="topTenData">
                <table class="table">
                    <tbody>
                        <tr><th>Record Id</th><th>Program Name</th><th>Supplier</th><th data-bind="text:currentUnit"> USD</th></tr>
                        <!-- ko foreach: TopTenProgramData -->
                        <tr>
                            <td><span data-bind="text: ItemID"></span></td>
                            <td><span data-bind="text: ITEMNAME"></span></td>
                            <td><span data-bind="text: STD_SUPPLIER"></span></td>
                            <td><span data-bind="text: SERIESVAL"></span></td>
                        </tr>
                        <!-- /ko -->
                        <tr data-bind="visible: !TopTenProgramData().length">
                            <td><span class="loading"></span></td>
                            <td><span></span></td>
                            <td><span></span></td>
                            <td><span></span></td>
                        </tr>
                    </tbody>
                </table>
                <a data-bind="click: RefineProgramData">View Program Data and refine on segment.</a>
            </div>
        </div>
    </div>
</div>
<!-- ko with:$data.gridChartVM.FacetsSearcher -->
@*<div id="facetsSearchToggle"  data-bind="css:{hidden:visible()} ">
        <button class="btn-info" data-bind="click:visible(!visible())"><span class="u-font-85">Facet Searcher</span></button>
    </div>*@
<div id="facetsSearchDataDiv" class="facetsSearchData " data-bind="css:{facetsSearchActive:results().length > 0 , hidden:visible()==false} ">
    <div>
        <div data-bind="css:{hidden:busy()==false}" class="loading text sm">Loading...</div>
    </div>
    <div>

        <div>
            <span class="pull-right" data-bind="css:{hidden:results().length == 0}">
                <button type="button" class="close" aria-label="Close" data-bind="click:function(){searchTerm('');}"><span aria-hidden="true">×</span></button>
            </span>
            <span class="width:80%;">
                <input placeholder="Search our filters" type="text" id="facetSearchText" data-bind="textInput:searchTerm" class="form-control width-80">
            </span>



        </div>
        @* <input class="u-margin-Ts" type="checkbox" id="ckRemoveAllFacetsOnApply" data-bind="checked:removeAllFacetsOnApply" /><label class="u-font-85" for="ckRemoveAllFacetsOnApply">Clear other filters.</label>*@

    </div>
    <div class="facetsSearchDataBody">
        <ul class="list-unstyled facetSearch">
            <!-- ko foreach: results -->
            <li>
                <h3 class="blue1" data-bind="css:{hidden:$parent.hideHeader($index())} , text:Title"></h3>
                <a class="u-margin-Ll" href="#" data-bind="click:$parent.Process"> <span data-bind="text:Item2"></span></a>
            </li>
            <!-- /ko -->
        </ul>
    </div>
</div>
<!-- /ko -->

<style>
    .subChartToolBar {
        z-index: 20 !important;
    }

    .facetsSearchActive {
        border: 1px dotted;
        background-color: #f8f8f8;
        width: 350px !important;
    }

    .facetsSearchData {
        position: relative;
        z-index: 1000 !important;
        padding: 10px 10px 10px 8px;
        overflow: auto;
        left: 0px;
    }

    .facetsSearchDataBody {
        overflow-y: auto;
        max-height: 500px;
    }

    h5 ~ .filter {
        list-style: outside none none;
        padding: 0 0 0 0 !important;
    }

    .chartLoading {
        height: 300px;
        width: 600px;
        background-color: rgb(100,100,100);
        align-content: center;
        background-image: url(/Assets/Images/BlurredContent/jmfColChart.gif);
        background-repeat: no-repeat;
        background-size: cover;
        opacity: 1;
        background-blend-mode: screen;
        box-shadow: 1px 1px 18px 10px white inset;
    }
</style>