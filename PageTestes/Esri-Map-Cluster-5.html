<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Arcade and Clustering</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/3.22/esri/themes/calcite/dijit/calcite.css"
    />
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/3.22/esri/css/esri.css"
    />
    <script src="https://js.arcgis.com/3.22/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      #info {
        top: 0px;
        right: 0px;
        position: absolute;
        z-index: 99;
        opacity: 0.9;
        background-color: white;
        padding: 0px 0px 0px 10px;
        max-width: 220px;
      }
    </style>

    <script type="text/plain" id="arcade-time-reported">
      //
      // Only valid in the U.S. after 2007
      //
      function getStandardTimeStart(y){
        // Daylight saving time ends on the
        // first Sunday in November
        var st;

        for(var d=1; d<8; d++){
          var tempDate = Date(y, 10, d, 2);
          st = IIF(Weekday(tempDate)==0, tempDate, st);
        }

        return st;
      }

      //
      // Only valid in the U.S. after 2007
      //
      function getDaylightTimeStart(y){
        // Daylight saving time starts on the
        // second Sunday in March
        var dt;

        for(var d=1; d<15; d++){
          var tempDate = Date(y, 2, d, 2);
          dt = IIF(Weekday(tempDate)==0, tempDate, dt);
        }

        return dt;
      }

      function toEasternTime(localDate){
        var d = toUTC(localDate);
        var yr = Year(d);
        // Eastern time zone offsets from UTC
        var edt = -4;
        var est = -5;

        var stStart = DateAdd(getStandardTimeStart(yr), Abs(edt), "hours");
        var dtStart = DateAdd(getDaylightTimeStart(yr), Abs(est), "hours");

        var inDaylightTime = (d >= dtStart) && (d < stStart);
        var timeOffset = IIF(inDaylightTime, edt, est);
        return DateAdd(d, timeOffset, "hours");
      }

      // toEasternTime is defined above
      var created = toEasternTime($feature.Created_Date);

      // Time of day
      var t = Hour(created);
      When(
        t >= 22 || t < 6, "Night",
        t >= 6 && t < 11, "Morning",
        t >= 11 && t < 13, "Midday",
        t >= 13 && t < 17, "Afternoon",
        t >= 17 && t < 22, "Evening",
      "Invalid date" );
    </script>

    <script type="text/plain" id="arcade-days-overdue">
      // Days incident closure was overdue

      var closed = IIF(IsEmpty($feature.Closed_Date), Now(), $feature.Closed_Date);
      var due = $feature.Due_Date;
      var closureDueDiff = DateDiff(closed, due, "days");
      IIF(IsEmpty(due), 0, closureDueDiff);
    </script>

    <script type="text/plain" id="arcade-overdue-text">
      // Days incident closure was overdue

      var closed = $feature.Closed_Date;
      var due = $feature.Due_Date;
      var closureDueDiff = DateDiff(closed, due, "days");
      WHEN(
        IsEmpty(closed), "Incident was not closed.",
        IsEmpty(due), "Incident due date was not recorded.",
        closureDueDiff > 0, "Incident closure was overdue by " + Round(closureDueDiff, 1) + " days.",
        closureDueDiff == 0, "Incident closure was on time.",
        closureDueDiff < 0, "Incident closure was early by " + Round(Abs(closureDueDiff), 1) + " days.",
        "N/A"
      );
    </script>

    <script type="text/plain" id="arcade-age-days">
      // Incident report age (days)

      var closed = $feature.Closed_Date;
      var created = $feature.Created_Date;
      IIF(!IsEmpty(closed) && !IsEmpty(created), DateDiff(closed, created, "days"), 0);
    </script>

    <script src="../JavaScript/esri-map-cluster-5.js"></script>
  </head>

  <body class="calcite">
    <div id="mapDiv"></div>
    <div id="picker1"></div>
    <div id="info">
      <div>
        Click on the Map<br />
        <br /><br /><br /><br /><br />
        and check the Console Log<br />
      </div>
      
  </body>
</html>
